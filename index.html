<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabela danych miesiƒôcznych</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
  table { border-collapse: collapse; background: white; width: 100%; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
  th { background-color: #eaeaea; }
  form { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px; }
  input, button, select { padding: 6px; }
  button { border: none; border-radius: 4px; cursor: pointer; }
  #addBtn { background-color: #0078d4; color: white; }
  #clearAll { background-color: #d9534f; color: white; }
  #exportBtn { background-color: #5cb85c; color: white; }
  .edit-btn, .delete-btn { padding: 2px 5px; font-size: 10px; border-radius: 3px; }
  .edit-btn { background-color: #f0ad4e; color: white; }
  .delete-btn { background-color: #d9534f; color: white; }
</style>
</head>
<body>

<h2>Tabela danych</h2>

<form id="dataForm">
  <input type="date" id="data" required>
  <input type="number" id="id180" placeholder="ID 180" step="0.01" required>
  <input type="number" id="id260" placeholder="ID 260" step="0.01" required>
  <input type="number" id="gaz" placeholder="GAZ" step="0.01" required>
  <input type="number" id="grzalka" placeholder="Grza≈Çka" step="0.01" required>
  <button type="submit" id="addBtn">Dodaj</button>
  <button type="button" id="clearAll">Wyczy≈õƒá dane</button>
  <button type="button" id="exportBtn">Eksportuj CSV</button>
</form>

<div style="margin-bottom:20px;">
  <label for="monthFilter">Filtruj po miesiƒÖcu:</label>
  <select id="monthFilter">
    <option value="">-- wybierz miesiƒÖc --</option>
    <option value="0">Stycze≈Ñ</option>
    <option value="1">Luty</option>
    <option value="2">Marzec</option>
    <option value="3">Kwiecie≈Ñ</option>
    <option value="4">Maj</option>
    <option value="5">Czerwiec</option>
    <option value="6">Lipiec</option>
    <option value="7">Sierpie≈Ñ</option>
    <option value="8">Wrzesie≈Ñ</option>
    <option value="9">Pa≈∫dziernik</option>
    <option value="10">Listopad</option>
    <option value="11">Grudzie≈Ñ</option>
  </select>
  <button type="button" id="monthFilterBtn">Filtruj</button>
  <button type="button" id="clearFilterBtn">Wyczy≈õƒá filtr</button>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>Lp</th>
      <th>Data</th>
      <th>ID 180</th>
      <th>ID 260</th>
      <th>GAZ</th>
      <th>Grza≈Çka</th>
      <th>Akcje</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<table id="diffTable">
  <thead>
    <tr>
      <th>Data</th>
      <th>Dane r√≥≈ºnicowe (oryginalne warto≈õci)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const BIN_ID = "69064f4f43b1c97be9916a28";
const API_KEY = "$2a$10$KvdpN6/53GdV2U00zsr2T.BoKtdLmYw8WFEnFXf1PKqSr9/QHMCJK";
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

let dataList = [];
let filteredList = null;

async function wczytajZChmury() {
  try {
    const res = await fetch(`${API_URL}/latest`, { headers: { "X-Master-Key": API_KEY } });
    const json = await res.json();
    dataList = Array.isArray(json.record) ? json.record : (json.record || []);
    renderTable();
  } catch (err) {
    console.error("B≈ÇƒÖd wczytywania danych:", err);
  }
}

async function zapiszDoChmury() {
  try {
    await fetch(API_URL, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(dataList)
    });
  } catch (err) {
    console.error("B≈ÇƒÖd zapisu do JSONBin:", err);
  }
}

function renderTable() {
  const base = filteredList || dataList;
  const list = base.slice().sort((a, b) => new Date(b.data) - new Date(a.data));

  const tbody = document.querySelector('#dataTable tbody');
  const diffBody = document.querySelector('#diffTable tbody');
  tbody.innerHTML = '';
  diffBody.innerHTML = '';

  list.forEach((item, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${item.data}</td>
      <td>${item.id180}</td>
      <td>${item.id260}</td>
      <td>${item.gaz}</td>
      <td>${item.grzalka}</td>
      <td>
        <button class="edit-btn" onclick="editRow('${item.id}')">‚úèÔ∏è</button>
        <button class="delete-btn" onclick="deleteRow('${item.id}')">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(row);

    diffBody.innerHTML += `
      <tr><td>${item.data}</td>
      <td>GAZ: ${item.gaz} | Grza≈Çka: ${item.grzalka} | 180: ${item.id180} | 260: ${item.id260}</td></tr>`;
  });
}

// Dodawanie danych
document.getElementById('dataForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const newItem = {
    id: Date.now(),
    data: document.getElementById('data').value,
    id180: parseFloat(document.getElementById('id180').value),
    id260: parseFloat(document.getElementById('id260').value),
    gaz: parseFloat(document.getElementById('gaz').value),
    grzalka: parseFloat(document.getElementById('grzalka').value)
  };
  dataList.push(newItem);
  await zapiszDoChmury();
  filteredList = null;
  renderTable();
  e.target.reset();
});

// Edycja i usuwanie
window.editRow = (id) => {
  const item = dataList.find(i => i.id == id);
  if (!item) return;
  document.getElementById('data').value = item.data;
  document.getElementById('id180').value = item.id180;
  document.getElementById('id260').value = item.id260;
  document.getElementById('gaz').value = item.gaz;
  document.getElementById('grzalka').value = item.grzalka;
};

window.deleteRow = async (id) => {
  if (!confirm("UsunƒÖƒá wpis?")) return;
  dataList = dataList.filter(i => i.id != id);
  await zapiszDoChmury();
  renderTable();
};

// Filtr miesiƒÖca (bez przelicze≈Ñ!)
document.getElementById('monthFilterBtn').addEventListener('click', () => {
  const m = document.getElementById('monthFilter').value;
  if (m === "") return alert("Wybierz miesiƒÖc!");
  filteredList = dataList.filter(d => new Date(d.data).getMonth() == m);
  renderTable();
});

// Wyczy≈õƒá filtr
document.getElementById('clearFilterBtn').addEventListener('click', () => {
  filteredList = null;
  document.getElementById('monthFilter').value = "";
  renderTable();
});

// Eksport CSV
document.getElementById('exportBtn').addEventListener('click', () => {
  const base = filteredList || dataList;
  const csv = ["Lp;Data;ID 180;ID 260;GAZ;Grza≈Çka"];
  base.forEach((item, i) => {
    csv.push(`${i + 1};${item.data};${item.id180};${item.id260};${item.gaz};${item.grzalka}`);
  });
  const blob = new Blob([csv.join("\n")], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "dane.csv";
  a.click();
});

wczytajZChmury();
</script>

</body>
</html>
