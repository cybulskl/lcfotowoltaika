<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PorÃ³wnanie miesiÄ…c vs poprzedni miesiÄ…c (per rok)</title>
<style>
  body{font-family:Arial,sans-serif;margin:18px;background:#f7f7f7}
  table{border-collapse:collapse;background:#fff;width:100%;margin-bottom:16px}
  th,td{border:1px solid #ccc;padding:8px 10px;text-align:center}
  th{background:#eee}
  form{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  input,select,button{padding:6px}
  button{border-radius:6px;border:none;cursor:pointer}
  .btn-primary{background:#0078d4;color:#fff}
  .btn-danger{background:#d9534f;color:#fff}
  .small{font-size:13px}
  #diffTable td{text-align:left}
</style>
</head>
<body>

<h2>Filtr miesiÄ…ca â€” porÃ³wnanie: miesiÄ…c vs poprzedni miesiÄ…c (w tym samym roku)</h2>

<form id="dataForm">
  <input type="date" id="data" required>
  <input type="number" id="id180" placeholder="ID 180" step="0.01" required>
  <input type="number" id="id260" placeholder="ID 260" step="0.01" required>
  <input type="number" id="gaz" placeholder="GAZ" step="0.01" required>
  <input type="number" id="grzalka" placeholder="GrzaÅ‚ka" step="0.01" required>
  <button class="btn-primary" type="submit" id="addBtn">Dodaj</button>
  <button class="btn-danger" type="button" id="clearAll">WyczyÅ›Ä‡ wszystkie</button>
</form>

<div style="margin-bottom:12px">
  <label for="monthFilter">Wybierz miesiÄ…c:</label>
  <select id="monthFilter">
    <option value="">-- wybierz --</option>
    <option value="0">StyczeÅ„</option><option value="1">Luty</option><option value="2">Marzec</option>
    <option value="3">KwiecieÅ„</option><option value="4">Maj</option><option value="5">Czerwiec</option>
    <option value="6">Lipiec</option><option value="7">SierpieÅ„</option><option value="8">WrzesieÅ„</option>
    <option value="9">PaÅºdziernik</option><option value="10">Listopad</option><option value="11">GrudzieÅ„</option>
  </select>
  <button id="monthFilterBtn" type="button">Filtruj miesiÄ…c</button>
  <button id="clearFilterBtn" type="button">WyczyÅ›Ä‡ filtr</button>
</div>

<table id="dataTable">
  <thead>
    <tr><th>Lp</th><th>Data</th><th>ID180</th><th>ID260</th><th>GAZ</th><th>GrzaÅ‚ka</th><th>Akcje</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Tabela rÃ³Å¼nicowa (miesiÄ…c vs poprzedni miesiÄ…c, per rok)</h3>
<table id="diffTable">
  <thead><tr><th>Rok</th><th>Opis</th></tr></thead>
  <tbody></tbody>
</table>

<script>
/* ---------- KONFIGURACJA (zachowaj swoje wartoÅ›ci) ---------- */
const BIN_ID = "69064f4f43b1c97be9916a28";
const API_KEY = "$2a$10$KvdpN6/53GdV2U00zsr2T.BoKtdLmYw8WFEnFXf1PKqSr9/QHMCJK";
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

/* ---------- STAN ---------- */
let dataList = [];      // wszystkie rekordy
let monthMode = false;
let monthSelected = null;

/* ---------- ELEMENTY ---------- */
const tbody = document.querySelector('#dataTable tbody');
const diffBody = document.querySelector('#diffTable tbody');
const form = document.getElementById('dataForm');
const clearAllBtn = document.getElementById('clearAll');
const monthFilter = document.getElementById('monthFilter');
const monthFilterBtn = document.getElementById('monthFilterBtn');
const clearFilterBtn = document.getElementById('clearFilterBtn');
const addBtn = document.getElementById('addBtn');

/* ---------- HELPERS ---------- */
const parseDate = s => new Date(s + 'T00:00:00'); // unikamy problemÃ³w ze strefami
const fmt = n => Number(n).toFixed(2);
const pad2 = n => String(n).padStart(2,'0');

/* ---------- Wczytanie / zapis (JSONBin) ---------- */
async function wczytajZChmury(){
  try{
    const r = await fetch(`${API_URL}/latest`, { headers: { "X-Master-Key": API_KEY } });
    const j = await r.json();
    dataList = Array.isArray(j.record) ? j.record : (j.record || []);
    // dodaj id jeÅ¼eli brak
    dataList = dataList.map(it => it.id ? it : ({ ...it, id: Date.now() + Math.floor(Math.random()*1000) }));
  }catch(e){
    console.warn("BÅ‚Ä…d wczytania (JSONBin):", e);
    dataList = dataList || [];
  }
  renderTable();
}

async function zapiszDoChmury(){
  try{
    await fetch(API_URL, {
      method: "PUT",
      headers: { "Content-Type":"application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(dataList)
    });
  }catch(e){ console.warn("BÅ‚Ä…d zapisu:", e); }
}

/* ---------- RENDER ---------- */
function renderTable(){
  tbody.innerHTML = '';
  diffBody.innerHTML = '';

  if(!monthMode){
    // normalny widok: pokaÅ¼ wszystkie rekordy posortowane DESC
    const list = dataList.slice().sort((a,b)=> new Date(b.data) - new Date(a.data));
    list.forEach((it, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td>
        <td>${it.data}</td>
        <td>${fmt(it.id180)}</td>
        <td>${fmt(it.id260)}</td>
        <td>${fmt(it.gaz)}</td>
        <td>${fmt(it.grzalka)}</td>
        <td><button onclick="startEdit('${it.id}')">âœï¸</button> <button onclick="deleteRow('${it.id}')">ğŸ—‘ï¸</button></td>`;
      tbody.appendChild(tr);
    });
    // w normalnym widoku nic w diffBody (albo moÅ¼esz chcieÄ‡ tam obliczeÅ„ â€” nie robiÄ™ ich teraz)
    diffBody.innerHTML = '<tr><td colspan="2" class="small">PrzeÅ‚Ä…cz na filtr miesiÄ…ca, aby zobaczyÄ‡ porÃ³wnania miesiÄ…c vs poprzedni miesiÄ…c (per rok).</td></tr>';
    return;
  }

  /* ---------- monthMode = true ---------- */
  const m = Number(monthSelected); // 0..11
  // Zbierz listÄ™ lat, dla ktÃ³rych istnieje wpis w miesiÄ…cu m (chcemy wiersz per rok gdy mamy cur)
  const yearsSet = new Set();
  dataList.forEach(item => {
    const dt = parseDate(item.data);
    if(dt.getMonth() === m) yearsSet.add(dt.getFullYear());
  });
  const years = Array.from(yearsSet).sort((a,b)=> b - a); // sort desc

  if(years.length === 0){
    tbody.innerHTML = `<tr><td colspan="7">Brak wpisÃ³w dla wybranego miesiÄ…ca.</td></tr>`;
    diffBody.innerHTML = `<tr><td colspan="2">Brak danych do porÃ³wnania.</td></tr>`;
    return;
  }

  // Dla kaÅ¼dego roku znajdÅº: cur = NAJPOÅ¹NIEJSZY wpis w tym roku i miesiÄ…cu m
  //                   prev = NAJPOÅ¹NIEJSZY wpis w tym roku i miesiÄ…cu m-1 (jeÅ›li m>0)
  //                          lub jeÅ›li m==0 -> prev = NAJPOÅ¹NIEJSZY wpis w roku-1 i miesiÄ…cu 11
  const processed = years.map(year => {
    // cur candidates: month == m and year == year
    const curCandidates = dataList.filter(it => {
      const dt = parseDate(it.data);
      return dt.getFullYear() === year && dt.getMonth() === m;
    });
    // pick latest by date
    let cur = null;
    if(curCandidates.length) cur = curCandidates.reduce((a,b) => new Date(a.data) > new Date(b.data) ? a : b);

    // prev candidate:
    let prev = null;
    if(m > 0){
      const prevC = dataList.filter(it => {
        const dt = parseDate(it.data);
        return dt.getFullYear() === year && dt.getMonth() === (m-1);
      });
      if(prevC.length) prev = prevC.reduce((a,b) => new Date(a.data) > new Date(b.data) ? a : b);
    } else {
      // m == 0 -> previous month is December of previous year
      const prevC = dataList.filter(it => {
        const dt = parseDate(it.data);
        return dt.getFullYear() === (year - 1) && dt.getMonth() === 11;
      });
      if(prevC.length) prev = prevC.reduce((a,b) => new Date(a.data) > new Date(b.data) ? a : b);
    }
    return { year, cur, prev };
  });

  // Render gÅ‚Ã³wnej tabeli: pokaÅ¼ cur (ostatni wpis wybranego miesiÄ…ca) dla kaÅ¼dego roku
  processed.forEach((p, idx) => {
    if(!p.cur) return; // nie powinniÅ›my tu trafiaÄ‡, bo years bazowaliÅ›my na cur istniejÄ…cym
    const it = p.cur;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td>
      <td>${it.data}</td>
      <td>${fmt(it.id180)}</td>
      <td>${fmt(it.id260)}</td>
      <td>${fmt(it.gaz)}</td>
      <td>${fmt(it.grzalka)}</td>
      <td><button onclick="startEdit('${it.id}')">âœï¸</button> <button onclick="deleteRow('${it.id}')">ğŸ—‘ï¸</button></td>`;
    tbody.appendChild(tr);

    // Oblicz rÃ³Å¼nicÄ™ cur - prev (jeÅ¼eli prev istnieje)
    let opis = '';
  if(p.prev){
  const curLabel = p.cur.data;
  const prevLabel = p.prev.data;

  const dgg = (Number(p.cur.gaz) - Number(p.prev.gaz)).toFixed(2);
  // --- liczenie rÃ³Å¼nic ---
  const curDate = parseDate(p.cur.data);
  const daysInMonth = new Date(curDate.getFullYear(), curDate.getMonth() + 1, 0).getDate();

  const dgRaw = Number(p.cur.gaz) - Number(p.prev.gaz);
  const dg = (dgRaw / daysInMonth).toFixed(2); // rÃ³Å¼nica GAZ / dni miesiÄ…ca
  const dr = (Number(p.cur.grzalka) - Number(p.prev.grzalka)).toFixed(2);
  const d180 = (Number(p.cur.id180) - Number(p.prev.id180)).toFixed(2);
  const d260 = (Number(p.cur.id260) - Number(p.prev.id260)).toFixed(2);

  opis = `${curLabel} vs ${prevLabel} â†’ GAZ: ${dg} (na dzieÅ„) | GAZ: ${dgg} | GrzaÅ‚ka: ${dr} | 180: ${d180} | 260: ${d260}`;
} else {
  opis = 'Brak danych poprzedniego miesiÄ…ca (brak wpisu)';
}

    diffBody.innerHTML += `<tr><td>${p.year}</td><td>${opis}</td></tr>`;
  });

}

/* ---------- Dodawanie / edycja / usuwanie ---------- */
let editId = null;
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const newItem = {
    id: editId || (Date.now() + Math.floor(Math.random()*1000)),
    data: document.getElementById('data').value,
    id180: Number(document.getElementById('id180').value),
    id260: Number(document.getElementById('id260').value),
    gaz: Number(document.getElementById('gaz').value),
    grzalka: Number(document.getElementById('grzalka').value)
  };
  if(editId){
    const idx = dataList.findIndex(x => String(x.id) === String(editId));
    if(idx !== -1) dataList[idx] = newItem;
    editId = null;
    addBtn.textContent = 'Dodaj';
  } else {
    dataList.push(newItem);
  }
  await zapiszDoChmury();
  monthMode = false;
  monthSelected = null;
  monthFilter.value = '';
  renderTable();
  form.reset();
});

window.startEdit = (id) => {
  const it = dataList.find(x => String(x.id) === String(id));
  if(!it) return alert('Nie znaleziono rekordu');
  document.getElementById('data').value = it.data;
  document.getElementById('id180').value = it.id180;
  document.getElementById('id260').value = it.id260;
  document.getElementById('gaz').value = it.gaz;
  document.getElementById('grzalka').value = it.grzalka;
  editId = it.id;
  addBtn.textContent = 'Zapisz zmiany';
};

async function deleteRow(id){
  if(!confirm('UsunÄ…Ä‡ wpis?')) return;
  const idx = dataList.findIndex(x => String(x.id) === String(id));
  if(idx !== -1) dataList.splice(idx,1);
  await zapiszDoChmury();
  renderTable();
}

clearAllBtn.addEventListener('click', async () => {
  if(!confirm('UsunÄ…Ä‡ wszystkie wpisy?')) return;
  dataList = [];
  await zapiszDoChmury();
  monthMode = false;
  monthSelected = null;
  monthFilter.value = '';
  renderTable();
});

/* ---------- Filtry ---------- */
monthFilterBtn.addEventListener('click', () => {
  const m = monthFilter.value;
  if(m === '') return alert('Wybierz miesiÄ…c');
  monthMode = true;
  monthSelected = Number(m);
  renderTable();
});

clearFilterBtn.addEventListener('click', () => {
  monthMode = false;
  monthSelected = null;
  monthFilter.value = '';
  renderTable();
});

/* ---------- Start ---------- */
wczytajZChmury();
</script>
</body>
</html>









