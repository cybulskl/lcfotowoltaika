<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tabela z danymi â€” filtr miesiÄ…ca (rÃ³Å¼nice rok do roku vs poprzedni miesiÄ…c)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
  table { border-collapse: collapse; background: white; width: 100%; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; min-width: 80px; }
  th { background: #eaeaea; }
  form { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; align-items:center; }
  input, select, button { padding:6px; }
  button { border-radius:6px; border:none; cursor:pointer; }
  #addBtn{background:#0078d4;color:#fff}
  #clearAll{background:#d9534f;color:#fff}
  #exportBtn{background:#5cb85c;color:#fff}
  .edit-btn{background:#f0ad4e;color:#fff;padding:4px 6px;border-radius:4px}
  .delete-btn{background:#d9534f;color:#fff;padding:4px 6px;border-radius:4px}
  #diffTable td{ text-align:left; }
  @media(max-width:768px){
    form{flex-direction:column;align-items:stretch}
    input,select,button{width:100%}
  }
</style>
</head>
<body>

<h2>Dodaj dane do tabeli</h2>

<form id="dataForm">
  <input type="date" id="data" required>
  <input type="number" id="id180" placeholder="ID 180" step="0.01" required>
  <input type="number" id="id260" placeholder="ID 260" step="0.01" required>
  <input type="number" id="gaz" placeholder="GAZ" step="0.01" required>
  <input type="number" id="grzalka" placeholder="GrzaÅ‚ka" step="0.01" required>
  <button type="submit" id="addBtn">Dodaj</button>
  <button type="button" id="clearAll">WyczyÅ›Ä‡ dane</button>
  <button type="button" id="exportBtn">Eksportuj do CSV</button>
</form>

<div style="margin-bottom:16px;">
  <label for="filterStart">Od daty:</label>
  <input type="date" id="filterStart">
  <label for="filterEnd">Do daty:</label>
  <input type="date" id="filterEnd">
  <button id="filterBtn" type="button">Filtruj zakres</button>
</div>

<div style="margin-bottom:20px;">
  <label for="monthFilter">Filtruj po miesiÄ…cu (porÃ³wnanie: <strong>miesiÄ…c vs poprzedni miesiÄ…c tego samego roku</strong>):</label>
  <select id="monthFilter">
    <option value="">-- wybierz miesiÄ…c --</option>
    <option value="0">StyczeÅ„</option><option value="1">Luty</option><option value="2">Marzec</option>
    <option value="3">KwiecieÅ„</option><option value="4">Maj</option><option value="5">Czerwiec</option>
    <option value="6">Lipiec</option><option value="7">SierpieÅ„</option><option value="8">WrzesieÅ„</option>
    <option value="9">PaÅºdziernik</option><option value="10">Listopad</option><option value="11">GrudzieÅ„</option>
  </select>
  <button id="monthFilterBtn" type="button">Filtruj miesiÄ…c</button>
  <button id="clearFilterBtn" type="button">WyczyÅ›Ä‡ filtr</button>
</div>

<!-- GÅ‚Ã³wna tabela -->
<table id="dataTable">
  <thead>
    <tr>
      <th>Lp</th>
      <th>Data</th>
      <th>ID 180</th>
      <th>ID 260</th>
      <th>GAZ</th>
      <th>GrzaÅ‚ka</th>
      <th>Akcje</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Tabela rÃ³Å¼nicowa -->
<table id="diffTable">
  <thead>
    <tr>
      <th>Rok / MiesiÄ…c</th>
      <th>Dane rÃ³Å¼nicowe (miesiÄ…c vs poprzedni miesiÄ…c w tym samym roku)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
/* CONFIG â€” zachowaj swoje wartoÅ›ci */
const BIN_ID = "69064f4f43b1c97be9916a28";
const API_KEY = "$2a$10$KvdpN6/53GdV2U00zsr2T.BoKtdLmYw8WFEnFXf1PKqSr9/QHMCJK";
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

/* STAN */
let dataList = [];        // wszystkie rekordy
let filteredList = null;  // lista filtrowana (zakres dat) â€” uÅ¼ywana w normalnym widoku
let monthMode = false;    // true = aktywny filtr miesiÄ…ca specjalny
let monthSelected = null; // numeric 0..11 kiedy monthMode = true

/* ELEMENTY */
const tbody = document.querySelector('#dataTable tbody');
const diffBody = document.querySelector('#diffTable tbody');
const form = document.getElementById('dataForm');
const addBtn = document.getElementById('addBtn');
const clearAllBtn = document.getElementById('clearAll');
const exportBtn = document.getElementById('exportBtn');
const filterStart = document.getElementById('filterStart');
const filterEnd = document.getElementById('filterEnd');
const filterBtn = document.getElementById('filterBtn');
const monthFilter = document.getElementById('monthFilter');
const monthFilterBtn = document.getElementById('monthFilterBtn');
const clearFilterBtn = document.getElementById('clearFilterBtn');

/* Helpers */
const parseDate = d => new Date(d + 'T00:00:00'); // bez strefowych niespodzianek
const pad2 = n => String(n).padStart(2,'0');

/* Wczytaj dane z JSONBin (jeÅ›li nie chcesz chmury â€” moÅ¼esz pominÄ…Ä‡ wywoÅ‚ania) */
async function wczytajZChmury(){
  try{
    const res = await fetch(`${API_URL}/latest`, { headers: { "X-Master-Key": API_KEY } });
    const json = await res.json();
    dataList = Array.isArray(json.record) ? json.record : (json.record || []);
    // jeÅ›li brak id w rekordach, nadaj losowe id
    dataList = dataList.map(item => item.id ? item : ({ ...item, id: Date.now() + Math.floor(Math.random()*1000) }));
  }catch(e){
    console.error("BÅ‚Ä…d wczytywania z JSONBin:", e);
    dataList = dataList || [];
  }
  renderTable();
}

/* Zapisz do chmury */
async function zapiszDoChmury(){
  try{
    await fetch(API_URL, {
      method: "PUT",
      headers: { "Content-Type":"application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(dataList)
    });
  }catch(e){ console.error("BÅ‚Ä…d zapisu:", e); }
}

/* Render â€” dwa tryby:
   - monthMode = false : normalny widok â€” wyÅ›wietl wszystkie rekordy (filteredList || dataList),
                         posortowane od najnowszych i oblicz rÃ³Å¼nice wzglÄ™dem poprzedniego w widoku
   - monthMode = true  : specjalny widok dla wybranego miesiÄ…ca (monthSelected):
                         pokaÅ¼ po jednym wierszu na kaÅ¼dy rok: rÃ³Å¼nica (miesiÄ…c - poprzedni miesiÄ…c tego samego roku)
*/
function renderTable(){
  tbody.innerHTML = '';
  diffBody.innerHTML = '';

  if(!monthMode){
    // normalny widok
    const base = filteredList || dataList;
    const list = base.slice().sort((a,b)=> new Date(b.data) - new Date(a.data)); // najnowsze pierwsze

    list.forEach((item, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${item.data}</td>
        <td>${Number(item.id180).toFixed(2)}</td>
        <td>${Number(item.id260).toFixed(2)}</td>
        <td>${Number(item.gaz).toFixed(2)}</td>
        <td>${Number(item.grzalka).toFixed(2)}</td>
        <td>
          <button class="edit-btn" onclick="startEdit('${item.id}')">âœï¸</button>
          <button class="delete-btn" onclick="deleteRow('${item.id}')">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);

      // rÃ³Å¼nice liczone wzglÄ™dem poprzedniego w widoku (posortowanego)
      let dane = '';
      if(idx > 0){
        const prev = list[idx-1];
        const dg = (Number(item.gaz) - Number(prev.gaz)).toFixed(2);
        const dr = (Number(item.grzalka) - Number(prev.grzalka)).toFixed(2);
        const d180 = (Number(item.id180) - Number(prev.id180)).toFixed(2);
        const d260 = (Number(item.id260) - Number(prev.id260)).toFixed(2);
        dane = `GAZ: ${dg} | GrzaÅ‚ka: ${dr} | 180: ${d180} | 260: ${d260}`;
      }
      diffBody.innerHTML += `<tr><td>${item.data}</td><td>${dane}</td></tr>`;
    });

  } else {
    // monthMode: dla wybranego miesiÄ…ca zwracamy jednÄ… liniÄ™ na rok:
    // najpierw zgrupuj wszystkie rekordy wedÅ‚ug roku dla wybranego miesiÄ…ca i dla poprzedniego miesiÄ…ca
    const m = Number(monthSelected); // 0..11
    // zbuduj mapÄ™: year -> { cur: rekord dla month m (jeÅ›li jest), prev: rekord dla month m-1 (jeÅ›li jest)}
    const map = new Map();
    dataList.forEach(item => {
      const dt = parseDate(item.data);
      const mm = dt.getMonth();
      const yy = dt.getFullYear();
      if(mm === m || mm === ((m+11)%12)){ // mm === m (current month) OR mm === m-1 (previous month, handles january->dec)
        if(!map.has(yy)) map.set(yy, { cur: null, prev: null });
        const bucket = map.get(yy);
        if(mm === m) bucket.cur = item;
        else if (mm === ((m+11)%12)) bucket.prev = item;
      }
    });

    // Important: for months where current month is Jan (0), prev month is Dec of same YEAR â€” that's OK per requirement.
    // Now convert map to array and sort by year desc
    const rows = Array.from(map.entries())
      .sort((a,b)=> b[0] - a[0]); // [ [year, {cur,prev}], ... ]

    // If there are years where prev is in DEC of previous year (e.g., current month = Jan, prev = Dec but previous year),
    // we should also consider prev from year-1. So handle that: for month m, prev month is m-1 â€” if m==0, prev month is 11 and belongs to year-1.
    // We'll rebuild rows more carefully to include that.
    const yearsSet = new Set();
    dataList.forEach(item => yearsSet.add(parseDate(item.data).getFullYear()));
    const years = Array.from(yearsSet).sort((a,b)=> b - a);

    const processed = []; // { year, cur, prev }
    years.forEach(year => {
      // find cur: record with month==m and year==year
      const cur = dataList.find(it => {
        const dt = parseDate(it.data);
        return dt.getFullYear() === year && dt.getMonth() === m;
      });
      // find prev: if m>0 then prev month same year else m==0 -> prev month 11 in year-1
      let prev = null;
      if(m > 0){
        prev = dataList.find(it => {
          const dt = parseDate(it.data);
          return dt.getFullYear() === year && dt.getMonth() === (m-1);
        });
      } else {
        // m == 0 -> prev is month 11 in year-1
        prev = dataList.find(it => {
          const dt = parseDate(it.data);
          return dt.getFullYear() === (year-1) && dt.getMonth() === 11;
        });
      }
      // Only include if cur exists (we want rows for years where chosen month exists)
      if(cur){
        processed.push({ year, cur, prev });
      }
    });

    // Render processed list (sorted desc by year)
    processed.forEach((itemObj, idx) => {
      const { year, cur, prev } = itemObj;
      // main table: show the current month record (cur) â€” date field is cur.data
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${cur.data}</td>
        <td>${Number(cur.id180).toFixed(2)}</td>
        <td>${Number(cur.id260).toFixed(2)}</td>
        <td>${Number(cur.gaz).toFixed(2)}</td>
        <td>${Number(cur.grzalka).toFixed(2)}</td>
        <td>
          <button class="edit-btn" onclick="startEdit('${cur.id}')">âœï¸</button>
          <button class="delete-btn" onclick="deleteRow('${cur.id}')">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);

      // diff calculation: cur - prev (same year, prev month). If prev missing -> show info.
      let dane = '';
      if(prev){
        const dg = (Number(cur.gaz) - Number(prev.gaz)).toFixed(2);
        const dr = (Number(cur.grzalka) - Number(prev.grzalka)).toFixed(2);
        const d180 = (Number(cur.id180) - Number(prev.id180)).toFixed(2);
        const d260 = (Number(cur.id260) - Number(prev.id260)).toFixed(2);
        // show which months are compared: e.g. 2025-07 vs 2025-06 (format)
        const curLabel = `${year}-${pad2(m+1)}`;
        let prevLabel;
        if(m > 0) prevLabel = `${year}-${pad2(m)}`;
        else prevLabel = `${year-1}-${pad2(12)}`;
        dane = `${curLabel} vs ${prevLabel} â†’ GAZ: ${dg} | GrzaÅ‚ka: ${dr} | 180: ${d180} | 260: ${d260}`;
      } else {
        dane = 'Brak danych poprzedniego miesiÄ…ca (brak wpisu)';
      }
      diffBody.innerHTML += `<tr><td>${year}</td><td>${dane}</td></tr>`;
    });

    // If processed is empty, show info
    if(processed.length === 0){
      tbody.innerHTML = `<tr><td colspan="7">Brak wpisÃ³w dla wybranego miesiÄ…ca.</td></tr>`;
      diffBody.innerHTML = `<tr><td colspan="2">Brak danych do porÃ³wnania.</td></tr>`;
    }
  }
}

/* Dodawanie / edycja / usuwanie */
let editId = null;
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const item = {
    id: editId || (Date.now() + Math.floor(Math.random()*1000)),
    data: document.getElementById('data').value,
    id180: Number(document.getElementById('id180').value),
    id260: Number(document.getElementById('id260').value),
    gaz: Number(document.getElementById('gaz').value),
    grzalka: Number(document.getElementById('grzalka').value)
  };
  if(editId){
    const idx = dataList.findIndex(x => String(x.id) === String(editId));
    if(idx !== -1) dataList[idx] = item;
    editId = null;
    addBtn.textContent = 'Dodaj';
  } else {
    dataList.push(item);
  }
  await zapiszDoChmury();
  filteredList = null;
  monthMode = false;
  monthSelected = null;
  monthFilter.value = '';
  renderTable();
  form.reset();
});

function startEdit(id){
  const it = dataList.find(x => String(x.id) === String(id));
  if(!it) return alert('Nie znaleziono rekordu');
  document.getElementById('data').value = it.data;
  document.getElementById('id180').value = it.id180;
  document.getElementById('id260').value = it.id260;
  document.getElementById('gaz').value = it.gaz;
  document.getElementById('grzalka').value = it.grzalka;
  editId = it.id;
  addBtn.textContent = 'Zapisz zmiany';
}

async function deleteRow(id){
  if(!confirm('UsunÄ…Ä‡ wpis?')) return;
  const idx = dataList.findIndex(x => String(x.id) === String(id));
  if(idx !== -1) dataList.splice(idx,1);
  await zapiszDoChmury();
  renderTable();
}

/* Clear all */
clearAllBtn.addEventListener('click', async () => {
  if(!confirm('UsunÄ…Ä‡ wszystkie dane?')) return;
  dataList = [];
  await zapiszDoChmury();
  filteredList = null;
  monthMode = false;
  monthSelected = null;
  monthFilter.value = '';
  renderTable();
});

/* Filtr po zakresie dat (normalny tryb) */
filterBtn.addEventListener('click', () => {
  monthMode = false;
  monthSelected = null;
  const s = filterStart.value ? parseDate(filterStart.value) : null;
  const e = filterEnd.value ? parseDate(filterEnd.value) : null;
  filteredList = dataList.filter(it => {
    const dt = parseDate(it.data);
    if(s && dt < s) return false;
    if(e && dt > e) return false;
    return true;
  });
  renderTable();
});

/* Filtr miesiÄ…ca (special mode) â€” obliczamy dla kaÅ¼dego roku rÃ³Å¼nicÄ™: month vs previous month in same year */
monthFilterBtn.addEventListener('click', () => {
  const m = monthFilter.value;
  if(m === '') { alert('Wybierz miesiÄ…c'); return; }
  monthMode = true;
  monthSelected = Number(m);
  // disable filteredList (we use monthMode)
  filteredList = null;
  renderTable();
});

/* WyczyÅ›Ä‡ filtr */
clearFilterBtn.addEventListener('click', () => {
  filteredList = null;
  monthMode = false;
  monthSelected = null;
  filterStart.value = '';
  filterEnd.value = '';
  monthFilter.value = '';
  renderTable();
});

/* Eksport CSV â€” eksportuje aktualny widok (miesiÄ™czny lub normalny) */
exportBtn.addEventListener('click', () => {
  if(!monthMode){
    const base = filteredList || dataList;
    const list = base.slice().sort((a,b)=> new Date(b.data) - new Date(a.data));
    const lines = ['Lp;Data;ID180;ID260;GAZ;Grzalka'];
    list.forEach((it,i) => lines.push(`${i+1};${it.data};${Number(it.id180).toFixed(2)};${Number(it.id260).toFixed(2)};${Number(it.gaz).toFixed(2)};${Number(it.grzalka).toFixed(2)}`));
    const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dane.csv'; a.click();
  } else {
    // monthMode export: export the diffBody table rows (year + computed string)
    const rows = Array.from(diffBody.querySelectorAll('tr'));
    const lines = ['Rok;Opis rÃ³Å¼nicy (miesiÄ…c vs poprzedni miesiÄ…c)'];
    rows.forEach(r => {
      const cols = r.querySelectorAll('td');
      if(cols.length >= 2){
        lines.push(`${cols[0].textContent};${cols[1].textContent.replace(/;/g,',')}`);
      }
    });
    const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dane_miesieczne_roznice.csv'; a.click();
  }
});

/* Start */
wczytajZChmury();
</script>

</body>
</html>
